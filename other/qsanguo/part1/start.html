<!doctype html>
<html class="no-js" lang="zh-cn" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="next" title="lua脚本" href="luaScript.html" /><link rel="prev" title="C/S架构" href="CSFramework.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.01.29 -->
        <title>游戏开始 - QT系杀文档 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">QT系杀文档  文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">QT系杀文档  文档</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">快速入门</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">游戏运行原理</span></p>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">神杀-v2</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 神杀-v2</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="process.html">运行流程</a></li>
<li class="toctree-l2"><a class="reference internal" href="CSFramework.html">C/S架构</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">游戏开始</a></li>
<li class="toctree-l2"><a class="reference internal" href="luaScript.html">lua脚本</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../part2/index.html">新月杀</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="id1">
<h1>游戏开始<a class="headerlink" href="#id1" title="Link to this heading">#</a></h1>
<p>由之前的讨论我们知道，游戏的起点是，服务器房间检测到人满以后，调用<code class="docutils literal notranslate"><span class="pre">start()</span></code>启动游戏，我们注意到Room继承于QThread是一个线程对象，因此实际的执行过程在<code class="docutils literal notranslate"><span class="pre">run()</span></code>函数中。</p>
<ul class="simple">
<li><p>首先，其会将所有玩家的互斥量进行封锁，目的是为了保证游戏的正常开始。然后执行<code class="docutils literal notranslate"><span class="pre">prepareForStart</span></code>进行复杂的准备工作，我们就考虑正常的8人身份场吧，其对应的表示标记为<code class="docutils literal notranslate"><span class="pre">08p</span></code>，此时调用最后一个else，如果配置中有<code class="docutils literal notranslate"><span class="pre">Config.RandomSeat</span></code>就打乱一下进房间时的座位；</p>
<ul>
<li><p>然后执行<code class="docutils literal notranslate"><span class="pre">assignRoles</span></code>进行身份的分配，“主公-&gt;Z-&gt;lord”、“忠臣-&gt;C-&gt;loyalist”、“反贼-&gt;F-&gt;rebel”、“内奸-&gt;N-&gt;renegade”，其保存在roles中通过<code class="docutils literal notranslate"><span class="pre">qShuffle</span></code>函数打乱以后，依次分配给每个玩家；</p></li>
<li><p>最后执行<code class="docutils literal notranslate"><span class="pre">adjustSeats</span></code>调整座位编号，简单来讲就是，主公设为1后，依次加起来。而每次设置完后，都会调用<code class="docutils literal notranslate"><span class="pre">broadcastProperty</span></code>和<code class="docutils literal notranslate"><span class="pre">doBroadcastNotify</span></code>目的其实就是为了通知客户端，更新参数和座位，以便同步到显示画面上。</p></li>
</ul>
</li>
<li><p>后面的using_countdown和玩家没啥关系，然后再根据模式设置进行不同的内容，我们显然隶属于最后一个，第一步是调用<code class="docutils literal notranslate"><span class="pre">chooseGenerals</span></code>进行选将，就是主公先选，其它玩家后选。主公选将调用<code class="docutils literal notranslate"><span class="pre">askForGeneral</span></code>；</p>
<ul>
<li><p>通过<code class="docutils literal notranslate"><span class="pre">tryPause()</span></code>测试暂停游戏，其不会暂停游戏，因为game_paused的初值为false，其目的是为了防止处于暂停游戏时而调用了暂停游戏的操作。否则它就会等待上一个暂停结束以后再继续执行；</p></li>
<li><p>后面的<code class="docutils literal notranslate"><span class="pre">notifyMoveFocus</span></code>用于通知主公该开始选将了，对应指令为<code class="docutils literal notranslate"><span class="pre">S_COMMAND_CHOOSE_GENERAL</span></code>，值得注意的是它被包装在了<code class="docutils literal notranslate"><span class="pre">S_COMMAND_MOVE_FOCUS</span></code>指令中，其在多个对象中用于多重等待；</p></li>
<li><p>函数<code class="docutils literal notranslate"><span class="pre">moveFocus</span></code>是一个拆包的过程，其将countdown的内容拆解出来，并触发信号focus_moved进行处理，这类信号与UI相关在roomscene中被绑定，其会取消其它的响应，通过<code class="docutils literal notranslate"><span class="pre">showProgressBar</span></code>将事件聚焦为countdown的内容，当然选将还没有开始，只是通知客户端将界面调整成适合选将；</p></li>
<li><p>接着是简化过程，比如将框为1时直接返回之类的，核心调用为<code class="docutils literal notranslate"><span class="pre">doRequest(player,</span> <span class="pre">S_COMMAND_CHOOSE_GENERAL,</span> <span class="pre">options,</span> <span class="pre">true);</span></code>，此时有大量准备工作，而发送的指令是<code class="docutils literal notranslate"><span class="pre">S_COMMAND_CHOOSE_GENERAL</span></code>参数为服务端给的武将，并且通过<code class="docutils literal notranslate"><span class="pre">getResult</span></code>等待结果；</p></li>
<li><p>当然其只是通过一个互斥bool值进行等待，而结果主要存储于玩家对象的<code class="docutils literal notranslate"><span class="pre">_m_clientResponse</span></code>中，这就是我们之前所说的收到REPLY型数据时，所修改的值。至于具体的选将过程就不看了，反正就是用客户端自己的UI选择，返回结果到<code class="docutils literal notranslate"><span class="pre">onPlayerChooseGeneral</span></code>函数，并以REPLY型数据发给服务器。</p></li>
</ul>
</li>
<li><p>对于其它玩家，直接调用<code class="docutils literal notranslate"><span class="pre">doBroadcastRequest</span></code>函数来发送<code class="docutils literal notranslate"><span class="pre">S_COMMAND_CHOOSE_GENERAL</span></code>指令来让它们选将，所能选的武将通过前面的<code class="docutils literal notranslate"><span class="pre">assignGeneralsForPlayers</span></code>函数获得，其中有大量不值一提的过滤过程，而双将模式会再执行一遍，最后提醒所有玩家更新武将数据；</p></li>
<li><p>武将选择完毕以后，通过<code class="docutils literal notranslate"><span class="pre">startGame()</span></code>游戏似乎开始了。并非如此，在其中依旧有大量准备过程，首先它会将武将的数据同步到玩家的身上，并AI给调试好；然后调用<code class="docutils literal notranslate"><span class="pre">preparePlayers</span></code>进行技能性别等数据的设置和同步，并进行取出牌堆preparePlayers进行打乱洗牌；最后，通过<code class="docutils literal notranslate"><span class="pre">S_COMMAND_AVAILABLE_CARDS</span></code>进行牌堆同步后，再发送<code class="docutils literal notranslate"><span class="pre">S_COMMAND_GAME_START</span></code>指令，我们的游戏才终于开始了。</p></li>
</ul>
<p>在玩家的<code class="docutils literal notranslate"><span class="pre">startGame</span></code>函数中，会正式将房间注册到本地，清点玩家数量，并发出game_started的信号，当然这些都是用来提醒绘制UI的，以后对于这类信号我们就懒得讲了，反正不是很重要。嗯嗯，又是一堆，总之我们又创建了一个线程RoomThread，并将其成功启动后的信号发送到<code class="docutils literal notranslate"><span class="pre">game_start</span></code>信号上，这个信号什么都没绑定，所以流程全在RoomThread的<code class="docutils literal notranslate"><span class="pre">run</span></code>函数中。</p>
<ul class="simple">
<li><p>首先，又是些注册房间线程的操作，无所谓了，关键是创建了GameRule对象，其是TriggerSkill的子类，也就是所谓的触发技，其含义是游戏流程通过时机触发技来实现，<code class="docutils literal notranslate"><span class="pre">addTriggerSkill</span></code>就是这些触发技添加的过程，懒得看了；</p></li>
<li><p>另外引擎自带的内容，暗将的操作等，全都被抽象成了触发技，游戏真正的启动过程在<code class="docutils literal notranslate"><span class="pre">try{}catch{}</span></code>块中。至于神杀中有哪些技能类型，可以查看<code class="docutils literal notranslate"><span class="pre">src/core/skill.h</span></code>，除触发技外，还有典型的视为技ViewAsSkill、免疫技ProhibitSkill、距离技DistanceSkill等等；</p></li>
<li><p>然后<code class="docutils literal notranslate"><span class="pre">constructTriggerTable</span></code>将玩家的技能也添加进去，并判断是否要移除因武将导致的衍生卡，整个游戏采用Event事件机制来运行，所有的事件类型定义在<code class="docutils literal notranslate"><span class="pre">src/core/structs.h</span></code>的枚举类TriggerEvent中。游戏开始时触发<code class="docutils literal notranslate"><span class="pre">GameReady</span></code>事件，事件进行的过程就是调用每个触发技的trigger函数，例如GameReady就能触发GameRule的事件，其中摸牌、手气卡、同步手牌初始化信息全在这个事件中进行；</p></li>
<li><p>最后调用<code class="docutils literal notranslate"><span class="pre">actionNormal</span></code>函数，里面是一个死循环，不断触发<code class="docutils literal notranslate"><span class="pre">TurnStart</span></code>即回合开始事件，并将下一个活着的玩家设置为下一个回合的对象，在第一轮中其会顺带触发一个<code class="docutils literal notranslate"><span class="pre">GameStart</span></code>事件，即游戏开始事件，看来无论哪一种三国杀，一轮的概念全都在回合里，我确实不是很能理解；</p></li>
<li><p>在一个回合中，先是经过很复杂地过程后判断是否触发一轮开始的<code class="docutils literal notranslate"><span class="pre">RoundStart</span></code>事件，然后通过<code class="docutils literal notranslate"><span class="pre">faceUp</span></code>进行翻面判定，没问题后触发回合开始了事件<code class="docutils literal notranslate"><span class="pre">TurnStarted</span></code>，并调用玩家的<code class="docutils literal notranslate"><span class="pre">play</span></code>执行回合；</p></li>
<li><p>一个回合的过程，哪个三国杀都一样，开始、判定、摸牌、出牌、弃牌、结束，而且连一轮开始RoundStart也一样地被扔到了回合之中，当然这里的RoundStart已经没了效果，被迁移到了上一步中。</p></li>
</ul>
<p>好了，对于游戏运行的解读终于结束了。</p>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="luaScript.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">lua脚本</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="CSFramework.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">C/S架构</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, fuwuzhizi
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=ab3e9284"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../_static/translations.js?v=beaddf03"></script>
    </body>
</html>