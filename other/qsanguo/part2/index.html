<!doctype html>
<html class="no-js" lang="zh-cn" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="prev" title="lua脚本" href="../part1/luaScript.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.01.29 -->
        <title>新月杀 - QT系杀文档 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">QT系杀文档  文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">QT系杀文档  文档</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">快速入门</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">游戏运行原理</span></p>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../part1/index.html">神杀-v2</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 神杀-v2</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../part1/process.html">运行流程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../part1/CSFramework.html">C/S架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../part1/start.html">游戏开始</a></li>
<li class="toctree-l2"><a class="reference internal" href="../part1/luaScript.html">lua脚本</a></li>
</ul>
</li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">新月杀</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="id1">
<h1>新月杀<a class="headerlink" href="#id1" title="Link to this heading">#</a></h1>
<p>接着，让我们再来看看与神杀类似的新月杀，其相关的编译和调试法都在<a class="reference external" href="https://fkbook-all-in-one.readthedocs.io/zh-cn/latest/develop/index.html">官方文档</a>中，此时其变成了一个QT项目。由于新月杀和神杀的框架基本相同，技术栈为C++ Qt和lua，使用swig进行接口绑定，游戏采用C/S运行架构，所以对于重复的内容就不再讨论了，我们主要来说说两者的区别。</p>
<section id="id2">
<h2>内核精简化<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>其含义就是尽可能的减少C++ Qt代码，将其视作一种类似驱动的东西。在新月杀中，主要有两种迁移，一种是原生接口lua化，其位于<code class="docutils literal notranslate"><span class="pre">lua/</span></code>文件夹中(与<code class="docutils literal notranslate"><span class="pre">packages/</span></code>中的卡牌武将包不是一个含义)，另一种是UI界面qml化，其位于<code class="docutils literal notranslate"><span class="pre">Fk/</span></code>文件夹中。</p>
<p>我们先来讲讲第一种情形，在core、client、server、network等几个核心组件中，保留了Player、Client、Server、Room等基本类，因为这些类都需要与系统的Socket通信进行交互，需要调用系统的API，而对于游戏过程只是把线程保留了下了，游戏机制则全部被分离了。同样地，新月杀也通过swig(位于<code class="docutils literal notranslate"><span class="pre">sec/swig/</span></code>中)将核心API与lua进行绑定，但更细致的实现过程，全部都在lua中实现和执行。</p>
<p>在Qt中，QML是一种强大的UI标记语言，再与QSS样式语言(新月杀并未使用)配合就可以做出十分复杂的界面，而且其还可以通过内嵌js代码来添加逻辑能力，总之就是非常的方便而强大。为此，我们来稍微看看，QML是如何加载并变成界面的，即看一下<code class="docutils literal notranslate"><span class="pre">main</span></code>函数中的内容。</p>
<ul class="simple">
<li><p>如它注释的那样，开始用于初始化各种信息，并设置了一个log功能来捕捉日志，然后是参数解析，版本、帮助、服务器直接过了，来看看我们的QApplication；</p></li>
<li><p>程序启动后先进入欢迎界面，并启动我们的qml加载引擎QQmlApplicationEngine，后面是加载翻译文本(由<code class="docutils literal notranslate"><span class="pre">lang/</span></code>下文件生成)，个人觉得中文其实够了，英语就是一堆拼音，属实没必要；</p></li>
<li><p>再接下来就是QML相关了，主要是向QML注入了几个全局变量，<code class="docutils literal notranslate"><span class="pre">FkVersion</span></code>和<code class="docutils literal notranslate"><span class="pre">SysLocale</span></code>是两个字符常量，分别代表版本和语言，<code class="docutils literal notranslate"><span class="pre">Backend</span></code>是新月杀自己写的一个QML后端类(定义于<code class="docutils literal notranslate"><span class="pre">src/ui/qmlbackend.cpp</span></code>)，用于管理QML并提供相关工具函数，<code class="docutils literal notranslate"><span class="pre">ModBackend</span></code>用于扩展管理(定义于<code class="docutils literal notranslate"><span class="pre">src/ui/mod.cpp</span></code>)，提供添加删除保存等操作，<code class="docutils literal notranslate"><span class="pre">Pacman</span></code>为包管理工具(定义于<code class="docutils literal notranslate"><span class="pre">src/core/packman.cpp</span></code>)，用于与服务器同步扩展使用，<code class="docutils literal notranslate"><span class="pre">Debugging</span></code>为一个bool值表示是否为调试模式，<code class="docutils literal notranslate"><span class="pre">OS</span></code>为一个字符串表示程序所在的操作系统，<code class="docutils literal notranslate"><span class="pre">AppPath</span></code>表示当前程序所在的目录；</p></li>
<li><p>接下来设置游戏根目录为搜索路径后，加载<code class="docutils literal notranslate"><span class="pre">Fk/main.qml</span></code>界面文件，后面一堆无需管的东西，看注释就行，程序就开始运行了。</p></li>
</ul>
<p>看来通过QML实现界面确实是简单明了啊。</p>
</section>
<section id="id3">
<h2>单机启动<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>在主要界面文件<code class="docutils literal notranslate"><span class="pre">Fk/main.qml</span></code>中，其显然并非单纯的显示主界面，除导入系统库外，其额外导入了js库<code class="docutils literal notranslate"><span class="pre">Logic.js</span></code>用于保存一系列的回调函数，还有每一个页面<code class="docutils literal notranslate"><span class="pre">Fk.Pages</span></code>，其定义于相应的文件夹下。内部的Item为主界面的承载体，Shortcut用于全屏快捷键的操作，在window下为“F11”键。<code class="docutils literal notranslate"><span class="pre">Loader</span></code>和Item差不多，只不过其可以设置source来直接载入其它的qml，此处用于那个菜单界面前的那个预加载动画界面对应<code class="docutils literal notranslate"><span class="pre">Fk/Splash.qml</span></code>，<code class="docutils literal notranslate"><span class="pre">Component.onCompleted</span></code>表示当前qml加载完后执行的函数。<code class="docutils literal notranslate"><span class="pre">MessageDialog</span></code>为一个退出对话框，当触发窗口的关闭事件时，回调用<code class="docutils literal notranslate"><span class="pre">onClosing</span></code>对应的函数，它就会来显示这个退出对话框。最后几个属于被动调用函数，没啥好说的。</p>
<p>在组件加载完后，mainStack(<code class="docutils literal notranslate"><span class="pre">Item.StackView</span></code>为一层一层的视图控件)会推入控件init(<code class="docutils literal notranslate"><span class="pre">Item.Component.Init</span></code>为自定义控件<code class="docutils literal notranslate"><span class="pre">Fk/Pages/Init.qml</span></code>的载体，所有Pages都是如此)。这个Init控件就是我们的主菜单界面，只不过马上就会被覆盖而没看见而已，它的另一个作用就是执行了<code class="docutils literal notranslate"><span class="pre">config.loadConf()</span></code>将设置载入。接着判断<code class="docutils literal notranslate"><span class="pre">config.firstRun</span></code>(<code class="docutils literal notranslate"><span class="pre">Item.Config</span></code>定义于<code class="docutils literal notranslate"><span class="pre">Config.qml</span></code>，用于加载、保存设置信息)看是否先加载教程界面，然后对于非Debug版本就载入我们之前说的Splash进行欢迎，其自带消失事件，点了就会回到Init主界面。最后是等待时的提示数据加载(游戏根目录的<code class="docutils literal notranslate"><span class="pre">waiting_tips.txt</span></code>)，它被保存到了Window的成员属性tipList中。</p>
<p>在菜单界面中，当我们点击“单机启动”时，对应按钮的<code class="docutils literal notranslate"><span class="pre">onClicked</span></code>被触发，其过程主要是更新<code class="docutils literal notranslate"><span class="pre">config</span></code>并设置主要窗口为busy状态(其会隐藏mainStack控件，并显示<code class="docutils literal notranslate"><span class="pre">Item.BusyIndicator、Item.Text</span></code>等组成的加载界面)，最后调用后台的<code class="docutils literal notranslate"><span class="pre">startServer</span></code>启动服务器和<code class="docutils literal notranslate"><span class="pre">joinServer</span></code>加入服务器。启动过程就是创建Server并监听，加入服务器就是创建Client并连接的过程，与神杀大差不差，不看了，当然新月杀丰富了房间列表等UI界面，功能更富足了一些。另外我们还要注意，创建Client是，会给予QML两个新的变量<code class="docutils literal notranslate"><span class="pre">ClientInstance</span></code>(ClientPlayer的实例化)和<code class="docutils literal notranslate"><span class="pre">Self</span></code>(Client的实例化)，并会创建lua环境执行两个lua脚本<code class="docutils literal notranslate"><span class="pre">lua/freekill.lua</span></code>和<code class="docutils literal notranslate"><span class="pre">lua/client/client.lua</span></code>。</p>
<p>两个变量不用看，主要看两个脚本，官方给了十分细致的注释，主要的目的是为代码的全面lua提供各式各样的环境。在客户端中，所有收到的信息均转交给路由器Router(定义于<code class="docutils literal notranslate"><span class="pre">src/network/router.cpp</span></code>)的handlePacket进行处理，消息类型同样为NOTIFICATION、REQUEST和REPLY三种，当客户端连入服务器后，主要收到的是NOTIFICATION型的<code class="docutils literal notranslate"><span class="pre">NetworkDelayTest</span></code>，当目的地为客户端时，就会通过<code class="docutils literal notranslate"><span class="pre">calllua</span></code>调用lua相关函数进行处理，它会调用Client下的callback(LuaFunction)，而这个callback会在lua中(位于<code class="docutils literal notranslate"><span class="pre">lua/client/client.lua</span></code>的<code class="docutils literal notranslate"><span class="pre">Client:initialize()</span></code>函数中)被初始。</p>
<p>信息处理函数主要有两步，先是查看lua环境的<code class="docutils literal notranslate"><span class="pre">fk.client_callback</span></code>是否有这个指令，有的话就直接执行，否则调用Client的<code class="docutils literal notranslate"><span class="pre">notifyUI</span></code>来让UI进行相关处理，同样在初始化中，它被指向了<code class="docutils literal notranslate"><span class="pre">fk.Backend:notifyUI()</span></code>函数，这个函数在C++ QT环境中有被申明(位于<code class="docutils literal notranslate"><span class="pre">src/swig/client.i</span></code>中)，此处只是将其定义了出来。而这个函数的作用在于，其在<code class="docutils literal notranslate"><span class="pre">main.qml</span></code>中被绑定到了组件<code class="docutils literal notranslate"><span class="pre">Item.Connections</span></code>(对应处理函数为<code class="docutils literal notranslate"><span class="pre">onNotifyUI</span></code>)上，其进行过滤以后，转交给<code class="docutils literal notranslate"><span class="pre">handleMessage</span></code>函数进行处理，而内容就是执行<code class="docutils literal notranslate"><span class="pre">Window.callbacks</span></code>中的函数(定义于<code class="docutils literal notranslate"><span class="pre">Fk/Logic.js</span></code>中)。</p>
<p>在回调中，我们看到NetworkDelayTest进行解密以后，主要调用了<code class="docutils literal notranslate"><span class="pre">Backend.replyDelayTest</span></code>，回到C++环境中，其进行了一把数据的md5校验，并调用<code class="docutils literal notranslate"><span class="pre">notifyServer</span></code>向服务器发送<code class="docutils literal notranslate"><span class="pre">SetUp</span></code>指令。服务器的初始处理位置是C++下Server的<code class="docutils literal notranslate"><span class="pre">processRequest</span></code>函数，而其只处理Setup函数，而过程还有点小繁琐，其中与加密通信相关的事我们就直接过了。</p>
<ul class="simple">
<li><p>首先调用<code class="docutils literal notranslate"><span class="pre">checkClientVersion</span></code>检测客户端的版本，其指的是游戏程序的版本，并不是lua层面的版本(两种版本的区别在于游戏的理念，“武将卡牌等内容全部通过拓展包来添加”，而lua版本指的就是扩展的内容)；</p></li>
<li><p>接着从数据库中进行UUID检索，查看其是否为被ban用户，是的话就滚蛋吧。数据库存放于<code class="docutils literal notranslate"><span class="pre">server/users.db</span></code>中，其初始化的SQL语句定义于<code class="docutils literal notranslate"><span class="pre">server/init.sql</span></code>，而这个uuid是系统唯一标识，与设备绑定，虽然在权限足够时还是可以修改的就是了，但唯一性已经很高了；</p></li>
<li><p>然后是<code class="docutils literal notranslate"><span class="pre">handleNameAndPassword</span></code>函数处理用户名和密码，其第一步是进行资源的md5校验，没通过的话，就提醒客户端执行<code class="docutils literal notranslate"><span class="pre">UpdatePackage</span></code>来强制同步扩展数据，此时服务器调用Pacman的<code class="docutils literal notranslate"><span class="pre">getPackSummary</span></code>函数作为参数，其查询了<code class="docutils literal notranslate"><span class="pre">packages/packages.db</span></code>这个数据库的信息，主要包含名称、url(下载地址)和hash(校验值)等信息，下载同步由用户自行进行；</p></li>
<li><p>后面是用户名检测和禁用词检测，名字没问题且数据库没注册数据的话就启动建号操作，对于已经注册过的用户名，会依次进行是否被ban检测、密码是否正确检测和进房前准备(比如官方注解的顶号机制)；</p></li>
<li><p>顺利通过各种检测后，就会开始用户升级了，这和神杀基本类似，此时按照官方的说明就是我们进入了一个大厅房间<code class="docutils literal notranslate"><span class="pre">lobby()</span></code>(为Server下的一个Room实例化，Id为0是初始的房间)，此时监听事件转化为<code class="docutils literal notranslate"><span class="pre">Room::handlePacket</span></code>进行处理；</p>
<ul>
<li><p>首先其会看是否为两种特殊指令，<code class="docutils literal notranslate"><span class="pre">CHAT</span></code>对应聊天界面，有着一系列相关操作，不想看了；</p></li>
<li><p>而<code class="docutils literal notranslate"><span class="pre">PushRequest</span></code>只在非大厅中适用，其用于将指令送入房间线程进行队列处理，过程全在lua中(<code class="docutils literal notranslate"><span class="pre">lua/server/room.lua</span></code>的<code class="docutils literal notranslate"><span class="pre">doRequest</span></code>)，与游戏过程相关，自己看吧；</p></li>
<li><p>最后其根据是否为大厅，而分别调用<code class="docutils literal notranslate"><span class="pre">lobby_actions</span></code>或<code class="docutils literal notranslate"><span class="pre">room_actions</span></code>(此处用于房间等待中的)下指令指向的函数。</p></li>
</ul>
</li>
<li><p>各种通知别的玩家的东西可以直接无视，此时服务器会先调用<code class="docutils literal notranslate"><span class="pre">setupPlayer</span></code>让玩家自己设置一下，主要是两个NOTIFICATION型指令<code class="docutils literal notranslate"><span class="pre">Setup</span></code>(此函数在lua中，用来更新客户端自己的Client的信息)和<code class="docutils literal notranslate"><span class="pre">SetServerSettings</span></code>(此函数在QML中，用来同步服务器的几个设置)；</p></li>
<li><p>最后<code class="docutils literal notranslate"><span class="pre">lobby()-&gt;addPlayer</span></code>让玩家进入大厅，其过程在大厅和房间之间是共用的。比如满员判定，游戏开始判定等，大厅理所应当不会游戏开始，而旁观则是另一类函数；</p>
<ul>
<li><p>如果非大厅，则通知每个玩家执行<code class="docutils literal notranslate"><span class="pre">AddPlayer</span></code>来更新玩家数据。接着就是玩家加入房间的玩家列表，玩家指向房间的互动操作；</p></li>
<li><p>进房间比较复杂，它会让玩家执行进房<code class="docutils literal notranslate"><span class="pre">EnterRoom</span></code>、添加玩家<code class="docutils literal notranslate"><span class="pre">AddPlayer</span></code>、更新游戏数据<code class="docutils literal notranslate"><span class="pre">UpdateGameData</span></code>等各项操作；</p></li>
<li><p>而进入大厅只执行<code class="docutils literal notranslate"><span class="pre">EnterLobby</span></code>，其在lua中有，不过只是调用<code class="docutils literal notranslate"><span class="pre">notifyUI</span></code>，也就是说最后还是执行QML中的内容。过程无非就是进行各种设置，取消好久以前的busy状态，并把<code class="docutils literal notranslate"><span class="pre">Fk/Pages/Lobby.qml</span></code>界面给推进主页面堆mainStack。</p></li>
</ul>
</li>
</ul>
<p>至此，单机启动结束了。</p>
</section>
<section id="id4">
<h2>交互体系<a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<p>由前面我们知道，新月杀有着一个极为复杂的交互体系<code class="docutils literal notranslate"><span class="pre">QML&lt;-&gt;C++</span> <span class="pre">Qt&lt;-&gt;lua</span></code>，但我们完全不必害怕，任何多语言编程都有一个核心，就是紧扣共通的低层接口，即在C++ Qt中的控制了。对于QML，其对应QQmlApplicationEngine创建的对象，对于lua，其对应CreateLuaState函数得到的指针，在C++层面上，数据管理主要通过这两个对象完成。</p>
<p>一个便利的点是QML和lua本质都是脚本语言，执行一遍以后，无非就是加入了一些全局变量、函数或者执行点什么。所以我们的第一步就是把握全局变量和函数有哪些，在<code class="docutils literal notranslate"><span class="pre">QML&lt;-&gt;C++</span></code>交互上，单纯函数的概念并不存在，所有函数都在全局变量的闭包之中，所以我们视函数为一种特殊的数据类型；在QML中，一种方式是通过在同目录下新建文件<code class="docutils literal notranslate"><span class="pre">Name.qml</span></code>来添加，另一种方式是在<code class="docutils literal notranslate"><span class="pre">qmldir</span></code>中把同目录下的js脚本封装进一个全局变量中；在C++中，主要通过<code class="docutils literal notranslate"><span class="pre">rootContext()-&gt;setContextProperty</span></code>函数实现把C++中的对象转化进QML的全局变量中。</p>
<p>在<code class="docutils literal notranslate"><span class="pre">Lua&lt;-&gt;C++</span></code>的交互上，就有那么一点复杂了，先要将C++的函数或变量引入lua，原生是十分复杂的，但好在我们有了swig工具，其作用就是通过一种特定的语言，简化绑定的过程，但真正的实现也是生成后的C++以原生的方法做到的；想要C++去调用lua的函数，同样有一套复杂的过程，比较可惜的是，swig没办法反向操作。但幸运的是，这种情形是比较少的，因为上层听从下层一直是开发的基本原则，不过新月杀有一步违反了这个原则，就是客户端收到服务器发送的执行指令时，其会把存在lua中的回调函数，下放到C++来执行。我想可能的原因是作为脚本语言的lua难以实现监听等待的动作，并非如此哦，实际上在服务器的房间交互中，就使用了lua的协程来处理玩家的<code class="docutils literal notranslate"><span class="pre">PushRequest</span></code>指令，可能是官方嫌麻烦就没用再这样做了。</p>
<p>交互体系其实也没什么好讲的了，lua和QML是不能直接进行交互的，都必需以C++作为中介，如果觉得数据传来传去很麻烦的话，一个简便的方法就是像官方的<code class="docutils literal notranslate"><span class="pre">Backend</span></code>一样，其本质是一个C++对象，但同时被绑定到了lua和QML两个环境中，因此无论哪边调用Backend，都会引起一定程度上的联动。在新月杀中，主要是承担逻辑部分的lua通知QML更新界面(<code class="docutils literal notranslate"><span class="pre">NotifyUI</span></code>)，而QML界面主要通过<code class="docutils literal notranslate"><span class="pre">lcall</span></code>(底层<code class="docutils literal notranslate"><span class="pre">Backend.callLuaFunction</span></code>)来执行lua的函数，从而在界面中完成某些lua方面的逻辑。</p>
<p>好了好了，就说这么多吧，并最后提一嘴，角色、卡牌和模式全都在<code class="docutils literal notranslate"><span class="pre">packages/</span></code>中作为扩展存在。</p>
<div align="center">
    <img src="./n_0t.jpg" alt="图片1" width="20%" style="max-width: 250px;">
    <img src="./n_emoprincess.jpg" alt="图片2" width="20%" style="max-width: 250px;">
    <img src="./n_hospair.jpg" alt="图片3" width="20%" style="max-width: 250px;">
	<img src="./n_ralph.jpg" alt="图片4" width="20%" style="max-width: 250px;">
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          <a class="prev-page" href="../part1/luaScript.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">lua脚本</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, fuwuzhizi
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">新月杀</a><ul>
<li><a class="reference internal" href="#id2">内核精简化</a></li>
<li><a class="reference internal" href="#id3">单机启动</a></li>
<li><a class="reference internal" href="#id4">交互体系</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=ab3e9284"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../_static/translations.js?v=beaddf03"></script>
    </body>
</html>